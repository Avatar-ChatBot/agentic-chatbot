services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QDRANT_URL=http://qdrant:6333
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  streamlit:
    build: .
    ports:
      - "8501:8501"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QDRANT_URL=http://qdrant:6333
    env_file:
      - .env
    command: streamlit run streamlit.py --server.port=8501 --server.address=0.0.0.0 --server.headless=true
    depends_on:
      redis:
        condition: service_healthy
      app:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8501/_stcore/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333" # REST API
      - "6334:6334" # gRPC API
    volumes:
      # Persistent volume for Qdrant data - data persists across restarts
      - qdrant_data:/qdrant/storage
      # Mount for snapshots (read-write required for temp directory creation)
      - ./qdrant_snapshots:/qdrant/snapshots
    environment:
      # Only set API key if provided (optional for local development)
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY:-}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "timeout", "3", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/6333" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  qdrant-restore:
    image: curlimages/curl:latest
    container_name: qdrant-restore
    depends_on:
      qdrant:
        condition: service_healthy
    environment:
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-informasi-umum-itb}
      - SNAPSHOT_DIR=/snapshots
      - SNAPSHOT_FILE=${QDRANT_COLLECTION_NAME:-informasi-umum-itb}_latest.snapshot
    volumes:
      # Read-only mount for snapshots
      - ./qdrant_snapshots:/snapshots:ro
      # Mount restore script
      - ./scripts/restore_qdrant_snapshot.sh:/restore.sh:ro
    command: >
      sh -c "
        chmod +x /restore.sh &&
        /restore.sh
      "
    restart: "no" # Only run once - exits immediately if collection exists
    # Exit code 0 means success (collection exists or restored)
    # Exit code 1 means failure (should not block other services)

volumes:
  redis_data:
    driver: local
  qdrant_data:
    driver: local
    # Qdrant data persists in this volume across container restarts
    # Data is only restored from snapshot if collection doesn't exist
    # To reset: docker-compose down -v (WARNING: deletes all data)


